# Stage 1 – Baseline Vulnerability Assessment

## Overview
The project ships with intentionally vulnerable Java components located in:

- `src/main/java/com/github/copilot/governancelab/service/AuthService.java`
- `src/main/java/com/github/copilot/governancelab/controller/PageController.java`
- `src/main/java/com/github/copilot/governancelab/controller/ApiController.java`
- `src/main/java/com/github/copilot/governancelab/repository/InsecureSessionRepository.java`
- `src/main/resources/templates/login.html`
- `src/main/resources/templates/dashboard.html`

Your goal in this stage is to catalogue risks, align them with governance guardrails, and prepare remediation guidance before fixing the files in place.

## Vulnerabilities Included

### AuthService.java
1. **Sensitive Data Logging**: Prints usernames and passwords to stdout.
2. **Insecure Token Generation**: Tokens are predictable (`username-UUID`).
3. **Password Persistence**: Encodes and stores user passwords in `target/session-store.txt`.
4. **Role Trust**: Grants `admin` role without verification.
5. **Broken Logout**: Leaves credential artifacts on disk.
6. **Session Dump Exposure**: `generateSessionDebugDump` aggregates secrets for debugging.

### ApiController.java
1. **Cookie Misconfiguration**: Sets session cookies without `HttpOnly`, `Secure`, or `SameSite`.
2. **Token Leakage**: Echoes tokens and base64 passwords in response headers.
3. **Token Transport**: Accepts tokens via query parameters.
4. **Unrestricted File Upload**: Writes files to disk without validation and returns file contents.
5. **Weak Error Handling**: Returns verbose errors with tokens.
6. **Debug Endpoint Exposure**: `/api/debug/sessions` leaks active session metadata.

### PageController.java & Templates
1. **Open Redirect**: Trusts `returnUrl` query parameter during login.
2. **Stored XSS**: Uses `th:utext` in `dashboard.html` to render unescaped HTML.
3. **Information Disclosure**: Shows API key, session ID, encoded/plain passwords, and server info.
4. **DOM Clobbering**: Injects user-controlled data directly into `header.innerHTML`.
5. **Session Fixation**: Reuses session token across requests without regeneration.
6. **Polling Without Throttling**: JavaScript fetch loop hits `/api/user` every second with raw tokens.

### InsecureSessionRepository.java
1. **Plaintext Credential Storage**: Appends tokens and base64 passwords to `target/session-store.txt`.
2. **Silent Failures**: Swallows IO exceptions, hiding data loss.
3. **Unbounded Session Map**: Keeps sessions in memory without eviction or encryption.

## Stage Goals
- Capture an executive summary of the current risk profile.
- Map each vulnerability to OWASP categories and note affected assets.
- Identify governance guardrails from `.github/copilot-instructions.md` that remediation work must satisfy.
- Decide which quality gates (Maven verify, Jacoco, dependency analysis) you will use to prove success later.

## Recommended Actions (Stage 1)
1. Launch Copilot **Plan Mode** and ask for a risk catalog covering all vulnerable classes and templates.
2. Save the analysis as `docs/plans/stage1-plan.md` (or similar) so downstream stages inherit the findings.
3. Highlight required documentation artifacts (`VULNERABILITIES.md`, `FIXES.md`, governance report updates) that must be produced before the workflow ends.
4. Transition to Stage 2 only after the plan is vetted in **Validation Mode** and the remediation scope is clear.

---

## Stage 2 – Remediation Guidelines

Once the assessment is complete, remediate these files **in place** using Copilot:

1. Launch Copilot **Plan Mode** again to outline the remediation tasks derived from Stage 1. Capture the steps in `docs/plans/stage2-plan.md` (or equivalent) and log assumptions in `docs/workflow-tracker.md`.
2. Refactor each vulnerable class/template directly. Keep historical evidence of risky behavior for audit (e.g., `FIXES.md`).
3. Validate every fix against `.github/copilot-instructions.md` guardrails—secure storage, sanitization, CSRF protection, error handling, etc.
4. Record successful commands (`mvn test`, `mvn verify`, `./scripts/run-all-checks.sh`, `./scripts/generate-report.sh`) along with results inside `docs/test-coverage.md`.
5. Document completed work, remaining risks, and follow-up items in `docs/workflow-tracker.md` before moving to Stage 3.
